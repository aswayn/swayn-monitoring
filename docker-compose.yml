version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: swayn-prometheus
    restart: unless-stopped
    environment:
      - TZ=Australia/Sydney
    volumes:
      - ./configs/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - monitoring
    depends_on:
      - alertmanager

  alertmanager:
    image: prom/alertmanager:latest
    container_name: swayn-alertmanager
    restart: unless-stopped
    environment:
      - TZ=Australia/Sydney
      - MSTEAMS_WEBHOOK_URL=${MSTEAMS_WEBHOOK_URL:-}
      - MSTEAMS_CRITICAL_WEBHOOK_URL=${MSTEAMS_CRITICAL_WEBHOOK_URL:-}
      - MSTEAMS_WARNING_WEBHOOK_URL=${MSTEAMS_WARNING_WEBHOOK_URL:-}
    volumes:
      - ./configs/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - ./configs/alertmanager/entrypoint.sh:/entrypoint.sh:ro
      - alertmanager_data:/alertmanager
    entrypoint: ["/entrypoint.sh"]
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--cluster.listen-address='
    networks:
      - monitoring

  bitwarden:
    image: vaultwarden/server:latest
    container_name: swayn-bitwarden
    restart: unless-stopped
    environment:
      - TZ=Australia/Sydney
      - WEBSOCKET_ENABLED=true
      - SIGNUPS_ALLOWED=true
      - INVITATIONS_ALLOWED=true
      - ADMIN_TOKEN=${BITWARDEN_ADMIN_TOKEN:-changeme}
      - DOMAIN=https://vault.corp.swayn.com
    volumes:
      - bitwarden_data:/data
    networks:
      - monitoring

  etcd:
    image: quay.io/coreos/etcd:v3.5.9
    container_name: swayn-etcd
    restart: unless-stopped
    environment:
      - TZ=Australia/Sydney
      - ETCD_NAME=etcd0
      - ETCD_DATA_DIR=/etcd-data
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd:2380
      - ETCD_INITIAL_CLUSTER=etcd0=http://etcd:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_AUTO_COMPACTION_RETENTION=1
    volumes:
      - etcd_data:/etcd-data
    networks:
      - monitoring
    ports:
      - "2379:2379"
      - "2380:2380"
    command: etcd --name etcd0 --data-dir /etcd-data --listen-client-urls http://0.0.0.0:2379 --advertise-client-urls http://etcd:2379 --listen-peer-urls http://0.0.0.0:2380 --initial-advertise-peer-urls http://etcd:2380 --initial-cluster etcd0=http://etcd:2380 --initial-cluster-state new --auto-compaction-retention 1

  loki:
    image: grafana/loki:2.9.0
    container_name: swayn-loki
    restart: unless-stopped
    environment:
      - TZ=Australia/Sydney
    volumes:
      - ./configs/loki/loki-config.yml:/etc/loki/loki-config.yml:ro
      - loki_data:/loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/loki-config.yml
    networks:
      - monitoring

  nodejs-scanner:
    build:
      context: ./scanner
      dockerfile: Dockerfile
    container_name: swayn-nodejs-scanner
    restart: unless-stopped
    environment:
      - TZ=Australia/Sydney
      - BITWARDEN_URL=http://bitwarden:80
      - BITWARDEN_USERNAME=${BITWARDEN_USERNAME}
      - BITWARDEN_PASSWORD=${BITWARDEN_PASSWORD}
      - ETCD_ENDPOINTS=etcd:2379
      - ETCD_PREFIX=/prometheus/targets/
    networks:
      - monitoring
    depends_on:
      - bitwarden
      - etcd

  grafana:
    image: grafana/grafana:latest
    container_name: swayn-grafana
    restart: unless-stopped
    environment:
      - TZ=Australia/Sydney
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_DATE_FORMATS_DEFAULT_TIMEZONE=Australia/Sydney
      - GF_INSTALL_PLUGINS=grafana-piechart-panel,grafana-worldmap-panel
    volumes:
      - grafana_data:/var/lib/grafana
      - ./configs/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./configs/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - monitoring
    depends_on:
      - prometheus
      - loki

  etcd-keypair-service:
    build:
      context: ./etcd-keypair-service
      dockerfile: Dockerfile
    container_name: swayn-etcd-keypair-service
    restart: unless-stopped
    environment:
      - TZ=Australia/Sydney
      - PORT=3002
      - ETCD_ENDPOINTS=etcd:2379
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-this}
    networks:
      - monitoring
    depends_on:
      - etcd

  nginx:
    image: nginx:alpine
    container_name: swayn-nginx
    restart: unless-stopped
    environment:
      - TZ=Australia/Sydney
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./configs/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./configs/nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    networks:
      - monitoring
    depends_on:
      - grafana
      - prometheus
      - alertmanager

volumes:
  prometheus_data:
    driver: local
  alertmanager_data:
    driver: local
  etcd_data:
    driver: local
  grafana_data:
    driver: local
  loki_data:
    driver: local
  nginx_logs:
    driver: local
  bitwarden_data:
    driver: local

networks:
  monitoring:
    driver: bridge